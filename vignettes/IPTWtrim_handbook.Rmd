---
title: "Introduction to `IPTWtrim` R package "
author: "Xiaoya Wang"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
  pdf_document:
    number_sections: true
    toc: TRUE
    toc_depth: 3
    citation_package: natbib
bibliography: references.bib
biblio-style: apalike
reference-section-title: References
---
\newpage

Welcome to the `IPTWtrim` package handbook! This vignette provides examples and usage instructions for the functions available in the `IPTWtrim` package. The package is designed to facilitate causal inference with inverse probability of treatment weighting (IPTW) and weight trimming. It enables users to estimate the Average Treatment Effect (ATE) using weight trimming and evaluate the performance of trimming for different trimming percentile based on simulation studies for a specific setting. We focus on the setting where three confounding variables $\mathbf{X}=(X_1, X_2, X_3)$ follows a multivariate normal distribution, treatment $A$ is generated by a logistic regression model including all confounding variables $\textbf{X}$, and the response variable $Y$ is a linear combination of confounding variables $\textbf{X}$, treatment $A$ and a standard normal distributed error term.

# Brief Introduction to IPTW Trimming

IPTW trimming is a statistical method used for estimating the Average Treatment Effect (ATE) in observational studies with confounding variables. It involves assigning weights to observations based on the probability of treatment given observed confounders. However, sometimes extreme weights can lead to biased estimates. Some researchers mentioned that IPTW trimming may address this by capping extreme weights at specific percentiles, improving estimation reliability [@stuart2010matching]. 


# Introduction to `IPTWtrim` R package


## Overview

The `IPTWtrim` R package is a powerful tool designed for causal inference using Inverse Probability of Treatment Weighting (IPTW) with symmetric weight trimming. It provides a set of functions to estimate the Average Treatment Effect (ATE) in observational studies, particularly when dealing with confounding variables that may affect both the treatment assignment and the outcome of interest. Also, it can assess the performance of different weighting percentile. 

The `IPTWtrim` package has the following architecture: 
```{r echo=FALSE}
PATH = "/Users/yaya/Desktop/IPTWtrim"
fs::dir_tree(path=PATH, type="any")
```

## Basic examples of data generation 
### Installation
First, install and load the required R packages: `MASS` [@mass], `ggplot2` [@ggplot2], `gridExtra` [@gridExtra].
```{r warning=FALSE, eval=FALSE, echo=TRUE}
install.packages("MASS")
install.packages("ggplot2")
install.packages("gridExtra")
library(MASS)
library(ggplot2)
library(gridExtra)
```


First, install and load the R package. 
```{r warning=FALSE, eval=TRUE, echo=TRUE}
library(devtools)
install_github("Dorayaya/IPTWtrim",
               build_vignettes = TRUE)
library(IPTWtrim)
```


### `dataGenFun()`: Generate Data for Our Specific Setting

Now, we can use `dataGenFun()` function to generate data for a binary treatment (A) and continuous confounding variables (x1, x2, x3). The confounding variables are assumed to be generated from a multivariate normal distribution with specified mean and covariance matrix. The binary treatment A is modeled using a logistic link function with specified coefficients. The continuous outcome Y is generated based on the treatment and confounders using a linear model with normally distributed errors. 

This table gives the description for each argument, and the default values are set according to the need of my STAT900 final project.

| Argument    | Description                                                                                           | Default Value     |
|:------------|:------------------------------------------------------------------------------------------------------|:------------------|
| `n`         | The number of observations to generate from the normal distribution. Should be a positive integer.  | `500`               |
| `mu`        | The mean vector of the multivariate normal distribution for predictors x1, x2, x3.                 | `c(10, 1, 11)`    |
| `sigma.mat` | The covariance matrix of the multivariate normal distribution for predictors x1, x2, x3.           | `matrix(c(11^2, 4, 4, 4, 3^2, 3, 4, 3, 8^2), 3)`         |
| `eta`       | The coefficients of the logistic regression model for the binary outcome A.                        | `c(-1.5, 0.1, 0.3, 0.2)` |
| `theta`     | The coefficients of the linear regression model for the continuous outcome Y.                       | `c(110, -12, -0.3, -0.8, -0.2)` |

The function will return a data frame including $A$, $X_1$, $X_2$, $X_3$ and $Y$. Here is an example with default parameter values: 
```{r warning=FALSE, eval=TRUE, echo=TRUE}
dataExample <- dataGenFun()
head(dataExample)
```

## Basic examples of estimation of Average Treatment Effect (ATE) using `measureATEfun`

The `measureATEfun` function estimates the Average Treatment Effect (ATE) using Inverse Probability of Treatment Weighting (IPTW) based on the data generated from the `dataGenFun` function. It allows users to evaluate the causal effect of the binary treatment $A$ on the continuous outcome $Y$ in the presence of confounding variables ($x1$, $x2$, $x3$), and assess the performence for a particular weight trimming percentile. The function uses IPTW to balance the distribution of covariates across treatment groups and provides options for trimming extreme weights and using robust standard errors for effect estimation. 

This table gives the description for each argument, and the default values are set based on the simulation design for my STAT900 final project.

| Argument    | Description                                                                                            | Default Value             |
|:------------|:-------------------------------------------------------------------------------------------------------|:--------------------------|
| `nsim`      | The number of simulations to perform. A positive integer.                                             | `1000`                    |
| `trim.p`    | The percentile of extreme weights to be trimmed on both ends. A numeric value between 0.5 and 1.      | `0.95`                    |
| `n`         | The number of observations in each simulated dataset. A positive integer.                            | `500`                     |
| `mu`        | The mean vector of the multivariate normal distribution for confounders x1, x2, x3.                  | `c(10, 1, 11)`            |
| `sig.mat`   | The covariance matrix of the multivariate normal distribution for confounders x1, x2, x3.            | `matrix(c(11^2, 4, 4, 4, 3^2, 3, 4, 3, 8^2), 3)` |
| `eta`       | The coefficients of the logistic regression model for the binary treatment A.                        | `c(-1.5, 0.1, 0.3, 0.2)`  |
| `theta`     | The coefficients of the linear regression model for the continuous outcome Y.                        | `c(110, -12, -0.3, -0.8, -0.2)` |

This function returns a matrix containing measures related to ATE estimation using trimming and the summary statistics for the estimated weights. The columns include:


| Measure        | Description                                                                                     |
|:---------------|:------------------------------------------------------------------------------------------------|
| `bias`         | The difference between the estimated and true ATE.                                              |
| `mse`          | The mean squared error (MSE) of the ATE estimator.                                             |
| `weight.mean`  | The average of trimmed weights across all simulations.                                         |
| `weight.ese`   | The empirical standard error of the mean of trimmed weights.                                   |
| `weight.asd`   | The average standard deviation of trimmed weights across all simulations.                     |
| `weight.max`   | The average maximum trimmed weight across all simulations.                                     |
| `weight.min`   | The average minimum trimmed weight across all simulations.                                     |

 Here is an example with default parameter values:
```{r warning=FALSE, eval=TRUE, echo=TRUE}
measureATE.example <- measureATEfun()
head(measureATE.example)
```

## Basic examples of summarizing results by `trimSummary`

`trimSummary` function performs a simulation study to evaluate the performance of different weight trimming percentiles. It calculates bias, empirical standard error (EmpSE), and mean squared error (MSE) for each weight trimming percentile specified in `trimperc.try`. Additionally, the function computes summary statistics for weights, including mean of trimmed weights, standard error of mean of trimmed weights, average standard deviation of trimmed weights, average maximum trimmed weight, and average minimum trimmed weight. The function then generates three plots using `ggplot2` [@ggplot2] and `gridExtra` [@gridExtra] package to visualize the relationship between weight trimming percentile and bias, EmpSE, and MSE. 

This table gives the description for each argument, and the default values are set based on the simulation design for my STAT900 final project.  

| Argument       | Description                                                                                             | Default Value                           |
|:---------------|:--------------------------------------------------------------------------------------------------------|:----------------------------------------|
| `nsim`         | The number of simulations to perform for each weight trimming percentile. An integer.                  | `1000`                                  |
| `n`            | The number of observations in each simulated dataset. An integer.                                      | `500`                                   |
| `mu`           | The mean vector of the multivariate normal distribution for confounders x1, x2, x3.                   | `c(10, 1, 11)`                          |
| `sig.mat`      | The covariance matrix of the multivariate normal distribution for confounders x1, x2, x3.             | `matrix(c(11^2, 4, 4, 4, 3^2, 3, 4, 3, 8^2), 3)` |
| `eta`          | The coefficients of the logistic regression model for the binary outcome A.                          | `c(-1.5, 0.1, 0.3, 0.2)`               |
| `theta`        | The coefficients of the linear regression model for the continuous outcome Y.                         | `c(110, -12, -0.3, -0.8, -0.2)`        |
| `trimperc.try` | A numeric vector specifying the weight trimming percentiles to evaluate.                              | `c(1, 0.99, 0.95, 0.9, 0.75, 0.5)`    |

The function performs a simulation study for each specified weight trimming percentile and calculates the following metrics for each percentile. 

| Metrics         | Description                                                                                     |
|:----------------|:------------------------------------------------------------------------------------------------|
| `trim.perc`     | Weight trimming percentile evaluated (e.g. 1, 0.99, 0.95, 0.9, 0.75, 0.5).                                 |
| `trim.prop`     | Weight trimming proportion calculated as (1 - `trim.perc`) * 2.                                |
| `weight.mean`   | The average of trimmed weights across all simulations.                                       |
| `weight.ese`    | The empirical standard error of the mean of trimmed weights.                                 |
| `weight.asd`    | The average standard deviation of trimmed weights across all simulations.                   |
| `weight.max`    | The average maximum trimmed weight across all simulations.                                   |
| `weight.min`    | The average minimum trimmed weight across all simulations.                                   |
| `bias`          | The difference between the estimated and true ATE.                                            |
| `ese`           | Empirical standard error of the estimator, computed as the square root of mse - bias^2.       |
| `mse`           | The mean squared error (MSE) of the ATE estimator.                                           |
